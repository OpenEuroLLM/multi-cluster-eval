name: Build and push Apptainer image (Leonardo)

on:
  push:
    paths:
      - 'apptainer/leonardo.def'
      - '.github/workflows/build-and-push-apptainer.yml'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Optional image tag (e.g. 25.06). Defaults to latest + commit SHA.'
        required: false
        type: string

jobs:
  build-push:
    name: Build & Publish SIF Artifact (Apptainer only)
    runs-on: 
      - runs-on=${{github.run_id}}/runner=8cpu-linux-x64/disk=large
    permissions:
      contents: read
      packages: write

    steps:
      - name: Delete huge unnecessary tools folder
        run: rm -rf /opt/hostedtoolcache

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show disk usage before cleanup
        run: |
          echo "=== df -h (before) ===" && df -h
          echo "=== Top-level disk usage under /opt ===" && du -h -d1 /opt | sort -hr | head -n20

      - name: Free up disk space on runner (optional but helpful)
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache || true
          sudo docker system prune -af || true

          sudo rm -rf /usr/local/julia* /usr/share/swift /usr/lib/jvm /usr/local/lib/node_modules || true

          # Purge additional unneeded APT packages (Java, and common build toolchains)
          sudo apt-get remove -y '^openjdk-.*' '^jdk-.*' '^dotnet-.*' || true
          sudo apt-get remove -y azure-cli google-cloud-sdk hhvm google-chrome-stable firefox powershell mono-devel || true
          sudo apt-get autoremove -y || true
          sudo apt-get clean || true

          # Remove caches
          sudo rm -rf /opt/microsoft /opt/az /opt/google /opt/pipx /opt/actionarchivecache /opt/runner-cache || true

      - name: Show disk usage after cleanup
        run: |
          echo "=== df -h (before) ===" && df -h
          echo "=== Top-level disk usage under /opt ===" && du -h -d1 /opt | sort -hr | head -n20
      
      - name: Install Apptainer
        run: |
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y ppa:apptainer/ppa
          sudo apt-get update
          sudo apt-get install -y apptainer

      - name: Login to GHCR for ORAS push
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "$GH_TOKEN" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Build SIF from definition file
        run: |
          apptainer --verbose build --fakeroot eval_env-leonardo.sif apptainer/leonardo.def

      - name: Push SIF to GHCR (ORAS)
        env:
          IMAGE_TAG: ${{ github.event.inputs.tag || github.sha }}
          GHCR_REPO: ghcr.io/${{ github.repository_owner }}
        run: |
          apptainer push --allow-unsigned eval_env-leonardo.sif oras://$GHCR_REPO/eval_env-leonardo:$IMAGE_TAG 